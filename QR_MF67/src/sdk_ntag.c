#include "sdk_ntag.h"
#include "app_def.h"

#ifdef PN5180
#include "ucosii/ucos_ii.h"
#endif


static unsigned char CARD_UID_INFO[25] = 
{
	0x44,0x00,					//SENS_RES(2 bytes)
	0x01,0x02,0x03,				//NFCID1(  bytes)
	0x00,						//SEL_RES(1 byte)
	0x01,0xFE,					//polling response 
	0xF0,0xF1,0xF2,0xF3,0xF4,0xF5,	//NFCID2(6 bytes)
	0x80,0x81,0x82,0x83,0x84,0x85,0x86,0x87, //pad (8 bytes)
	0xAA,0xBB, //system code (2 bytes)
	0xFE //NFCID3 (1 byte)
};


#define Block_Capacity 231

// NTAG216
unsigned char Ntag_Block[Block_Capacity][4]= 
{
	{0x04,0xDF,0x73,0x20}, 
	{0x2A,0x5B,0x49,0x80}, 
	{0xB8,0x48,0x00,0x00},
	{0xE1,0x10,0x6D,0x00},
	{0x03,0x0E,0xD1,0x01},
	{0x0A,0x55,0x01,0x62},
	{0x61,0x69,0x64,0x75},
	{0x2E,0x63,0x6F,0x6D},
	{0xFE,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0xBD},
	{0x04,0x00,0x00,0xFF},
	{0x00,0x05,0x00,0x00},
	{0xFF,0xFF,0xFF,0xFF},
	{0x00,0x00,0x00,0x00}
};

void set_ntag_block(unsigned char *buff, int length)
{
	int i = 0;

	APP_TRACE_BUFF_TIP(buff, length, "NDEF MESSAGE");

	if (length > 0)
	{
		Ntag_Block[4][1] = length;
		Ntag_Block[4][2] = buff[0];
		Ntag_Block[4][3] = buff[1];
		for (i=0; i<length-2; i++)
		{
			Ntag_Block[i/4+5][i%4] = buff[i+2];
		}
		Ntag_Block[i/4+5][i%4] = 0xFE;
	}
	//APP_TRACE_BUFF_TIP(Ntag_Block, 60, "NTAG BLOCK");
}

char get_url_type(char * url, pload_data *pload)
{	

	if (strstr(url, "http://") != NULL)
	{
		if (strstr(url, "www.") != NULL)
		{
			pload->len = strlen(url) - 11;
			pload->pyload = url + 11;
			return URI_ID_0x01;
		}
		else
		{
			pload->len = strlen(url) - 7;
			pload->pyload = url + 7;
			return URI_ID_0x03;
		}
	}
	else if (strstr(url, "https://") != NULL)
	{
		if (strstr(url, "www.") != NULL)
		{
			pload->len = strlen(url) - 12;
			pload->pyload = url + 12;
			return URI_ID_0x02;
		}
		else
		{
			pload->len = strlen(url) - 8;
			pload->pyload = url + 8;
			return URI_ID_0x04;
		}
	}
}

void set_ntag_url(char *url)
{
	char ndefMessage[256] = {0};
	pload_data payload = {0};
	char type;
	int len;

	ndefMessage[0] = (byte)0xD1;
	ndefMessage[1] = (byte)0x01;
	ndefMessage[3] = (byte)0x55;
	type = get_url_type(url, &payload);
	ndefMessage[4] = type;
	len = payload.len + 1;
	APP_TRACE("%d", len);
	ndefMessage[2] = len;
	memcpy(&ndefMessage[5], payload.pyload, payload.len);

	set_ntag_block(ndefMessage, strlen(ndefMessage));
}

/*
void set_ntag_url(char *url)
{
	char tlvEncodedData[512] = {0};
	char ndefMessage[256] = {0};
	int len = 0;

	ndefMessage[0] = (byte)0xD1;
	ndefMessage[1] = (byte)0x01;
	ndefMessage[4] = (byte)0x55;
	if (strcmp(url, "http://www"))
	{
		ndefMessage[3] = strlen(url)-10;
		ndefMessage[5] = (byte)0x01;
	}

	len = strlen(ndefMessage);
	if (len < 255) {
		tlvEncodedData[0] = (byte)0x03;  // NDEF TLV tag
		tlvEncodedData[1] = (byte)(len & 0xFF);  // NDEF TLV length (1 byte)
		memcpy(tlvEncodedData, ndefMessage, len);
		tlvEncodedData[2 + len] = (byte)0xFE;  // Terminator TLV tag
	} else {
		tlvEncodedData[0] = (byte)0x03;  // NDEF TLV tag
		tlvEncodedData[1] = (byte)0xFF;  // NDEF TLV length (3 byte, marker)
		tlvEncodedData[2] = (byte)((len >> 8) & 0xFF);  // NDEF TLV length (3 byte, hi)
		tlvEncodedData[3] = (byte)(len & 0xFF);          // NDEF TLV length (3 byte, lo)
		memcpy(tlvEncodedData, ndefMessage, len);
		tlvEncodedData[4 + len] = (byte)0xFE;  // Terminator TLV tag
	}
}
*/

void ntag_config()
{
    Sys_rfid_emulate_config(CARD_UID_INFO, sizeof(CARD_UID_INFO), Ntag_Block, Block_Capacity);
}

void sdk_ntag_test(void)
{		
	unsigned int tick1 = Sys_getTick();

	Sys_rfid_emulate_init();	
	ntag_config();

	{
		gui_begin_batch_paint();
		gui_clear_dc();
		gui_textout_line_center("NTAG Test", GUI_LINE_TOP(0));
		gui_text_out_win_center("Pls touch phone");
		gui_end_batch_paint();
	}


	while(1) 
	{		
		Sys_rfid_emulate_process();
		Sys_Sleep(1);
		if (Sys_CheckTimeover(tick1 , 10000) != 0)	{	// Check page timeout
			break;
		}
	}

	Sys_rfid_emulate_deinit();
}

#ifdef PN5180
unsigned char g_aNdefFile[] = {0x00, 0x0E, 0xD1, 0x01, 0x0A, 0x55, 0x02, 0x62, 0x61, 0x69, 0x64, 0x75, 0x2E, 0x63, 0x6F, 0x6D};
unsigned char g_aNdefFile2[] = {0x00, 0x0E, 0xD1, 0x01, 0x10, 0x55, 0x01, 0x6D, 0x6F, 0x72, 0x65, 0x66, 0x75, 0x6E, 0x2D, 0x65, 0x74, 0x2E, 0x63, 0x6F, 0x6D, 0x2F};
extern int ntag_on;
extern int rf;
void PN5180_ntag_test()
{
	st_gui_message pMsg;
	mf_rfid_hce_set_ndef(g_aNdefFile, sizeof(g_aNdefFile));
	{
		gui_begin_batch_paint();
		gui_clear_dc();
		gui_textout_line_center("NTAG Test", GUI_LINE_TOP(0));
		gui_text_out_win_center("Pls touch phone");
		gui_end_batch_paint();
	}

	ntag_on = 1;
	if (rf)
	{
		mf_rfid_hce_open();
		rf = 0;
	}
	while(1)
	{
		Sys_Delay(1);
		if (gui_get_message(&pMsg, 5) == 0)
		{
			if (pMsg.message_id == GUI_KEYPRESS)
			{
				if (pMsg.wparam == GUI_KEY_QUIT)
				{
					APP_TRACE("ntag quit");
					ntag_on = 0;
// 					Sys_Delay(100);
// 					mf_rfid_hce_close();
					break;
				}
// 				else if (pMsg.wparam == GUI_KEY_OK)
// 				{
// 					ntag_on = 0;
// 					Sys_Delay(100);
// 					mf_rfid_hce_set_ndef(g_aNdefFile2, sizeof(g_aNdefFile2));
// 					ntag_on = 1;
// 				}
			}
		}
	}
}
#endif