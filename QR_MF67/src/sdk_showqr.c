#include "app_def.h"
#include "pub/qrencode/QrEncode.h"
#include "sdk_ntag.h"


#define QR_WIDTH	80
#define QR_HEIGHT	80
#define TEMP "data\\qr.bmp"
/*
unsigned char CARD_UID_INFO[25] = 
{
	0x44,0x00,					//SENS_RES(2 bytes)
	0x01,0x02,0x03,				//NFCID1(  bytes)
	0x00,						//SEL_RES(1 byte)
	0x01,0xFE,					//polling response 
	0xF0,0xF1,0xF2,0xF3,0xF4,0xF5,	//NFCID2(6 bytes)
	0x80,0x81,0x82,0x83,0x84,0x85,0x86,0x87, //pad (8 bytes)
	0xAA,0xBB, //system code (2 bytes)
	0xFE //NFCID3 (1 byte)
};


#define Block_Capacity 231

// NTAG216
unsigned char Ntag_Block[Block_Capacity][4]= 
{
	{0x04,0xDF,0x73,0x20}, 
	{0x2A,0x5B,0x49,0x80}, 
	{0xB8,0x48,0x00,0x00},
	{0xE1,0x10,0x6D,0x00},
	{0x03,0x0E,0xD1,0x01},
	{0x0A,0x55,0x01,0x62},
	{0x61,0x69,0x64,0x75},
	{0x2E,0x63,0x6F,0x6D},
	{0xFE,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0xBD},
	{0x04,0x00,0x00,0xFF},
	{0x00,0x05,0x00,0x00},
	{0xFF,0xFF,0xFF,0xFF},
	{0x00,0x00,0x00,0x00}
};

void set_ntag_block(unsigned char *buff, int length)
{
	int i = 0;

	if (length > 0)
	{
		Ntag_Block[4][1] = length;
		Ntag_Block[4][2] = buff[0];
		Ntag_Block[4][3] = buff[1];
		for (i=0; i<length-2; i++)
		{
			Ntag_Block[i/4+5][i%4] = buff[i+2];
		}
		Ntag_Block[i/4+5][i%4] = 0xFE;
	}
}*/

int showQr(char *amt, char *data)
{
	Param_QR_INFO qr_info;

	char * bitmap = (char *)Util_Malloc(QR_HEIGHT*QR_HEIGHT/8);
	int width = 0;
	int temp = 0;
	int nQr_width = 0;
	int nQr_heith = 0;
	int ret = 0;
	//int zoom = LCD_IS_TFT_SCREEN ? 2 : 1;
	int zoom =  1;
	int left,top;
	int length = strlen(data);
	st_qr_data  * mpos_qr_data = mpos_func_get_qr_data();

	nQr_width = gui_get_width();
#ifdef WIN32
	nQr_heith = gui_get_height();
#else
	nQr_heith = gui_get_height()-gui_line_get_height()*2-10;
#endif
	qr_info.moudleWidth = 1; 
	qr_info.nLevel = 0;     
	qr_info.nVersion = 0;  
	mfSetQrSize(72);
	memset(bitmap , 0 , QR_HEIGHT*QR_HEIGHT/8);
	while(qr_info.moudleWidth > 0 && (width <= 0 || width > nQr_heith))
	{ 
		memset(bitmap , 0 , QR_HEIGHT*QR_HEIGHT/8);
		width = mfGeneCodePic(data , length, &qr_info , bitmap);
		
		qr_info.moudleWidth --;
		
	}	
	if(width > 0)
	{
		gui_begin_batch_paint();
		gui_clear_dc();
					
		gui_set_title(amt);

		temp = width * zoom;
		while(1)
		{ 
			if (temp < nQr_heith)
			{
				zoom++;
				temp = width * zoom;
			} 
			else if (temp == nQr_heith)
			{
				break;
			}
			else
			{
				zoom--;
				temp = width * zoom;
				break;
			}
		}
		left = (gui_get_width() - width * zoom)  / 2;
		top = GUI_LINE_TOP(1)+5; 
		gui_out_bits_zoom(left, top ,(unsigned char *)bitmap , width , width , 0, zoom);	
                   
		if (strlen(mpos_qr_data->prompt) > 0)
			gui_textout_line_center(mpos_qr_data->prompt, GUI_LINE_TOP(10));
		else
			gui_textout_line_center("Scan code", GUI_LINE_TOP(10));
				
		gui_end_batch_paint();
	}
	else
	{
		gui_messagebox_show("Prompt","Failed to generate QR code","","confirm", 3000 );
		ret = -1;
	}
	Util_Free(bitmap);
	
	return ret;
}

int showQr2(char *title)
{
	Param_QR_INFO qr_info;
	int i;
	int msg_ret; 
	st_gui_message pMsg;
	char * bitmap = (char *)Util_Malloc(QR_HEIGHT*QR_HEIGHT/8);
	int width = 0;
	int temp = 0;
	int nQr_width = 0;
	int nQr_heith = 0;
	int ret = 0;
	unsigned int tick1 = Sys_TimerOpen(60000);		
	//int zoom = LCD_IS_TFT_SCREEN ? 2 : 1;		need to be test 1 or 2
	int zoom =  1;
	int left,top;
	char *data= "https://www.google.com/";//"http://en.morefun-et.com";
	int length = strlen(data);

	set_ntag_url(data);
	Sys_rfid_emulate_init();

	ntag_config();

	nQr_width = gui_get_width();
#ifdef WIN32
	nQr_heith = gui_get_height();
#else
	nQr_heith = gui_get_height()-gui_line_get_height()*2-10;
#endif
	qr_info.moudleWidth = 1; 
	qr_info.nLevel = 0;     
	qr_info.nVersion = 0;   
	mfSetQrSize(48);
	memset(bitmap , 0 , QR_HEIGHT*QR_HEIGHT/8);
	while(qr_info.moudleWidth > 0 && (width <= 0 || width > nQr_heith))
	{ 
		memset(bitmap , 0 , QR_HEIGHT*QR_HEIGHT/8);
		width = mfGeneCodePic(data , length, &qr_info , bitmap);
		qr_info.moudleWidth --;
	}	
	gui_post_message(GUI_GUIPAINT, 0 , 0);
	if(width > 0)
	{
		while(1)
		{
			Sys_rfid_emulate_process();
			if (Sys_TimerCheck(tick1) == 0)	
			{
				ret = -3;
				break;
			}
			msg_ret = gui_get_message(&pMsg, 5);
			if(msg_ret == 0)
			{
				if (pMsg.message_id == GUI_GUIPAINT) 
				{
					gui_begin_batch_paint();
					gui_clear_dc();

					gui_set_title(title);
					temp = width * zoom;
					while(1)
					{ 
						if (temp < nQr_heith)
						{
							zoom++;
							temp = width * zoom;
						} 
						else if (temp == nQr_heith)
						{
							break;
						}
						else
						{
							zoom--;
							temp = width * zoom;
							break;
						}
					} 
					left = (gui_get_width() - width * zoom)  / 2;
					top = GUI_LINE_TOP(1)+5; 
					gui_out_bits_zoom(left, top ,(unsigned char *)bitmap , width , width , 0, zoom);	
					gui_textout_line_center("Scan code", GUI_LINE_TOP(10));
				
					gui_end_batch_paint();
				}
				else if (pMsg.message_id == GUI_KEYPRESS)
				{
					if(pMsg.wparam== GUI_KEY_QUIT)
					{
						ret = -2;
						break;
					}
				}
				gui_proc_default_msg(&pMsg);
			}	
		}
	}
	else
	{
		gui_messagebox_show("Prompt","Failed to generate QR code","","confirm", 3000 );
		ret = -1;
	}
	Util_Free(bitmap);
	Sys_rfid_emulate_deinit();

	return ret;
}
